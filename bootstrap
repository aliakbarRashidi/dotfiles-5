#!/usr/bin/env bash

set -e

###
# functions
###

installed() { hash $1 &> /dev/null; }

###
# globals
###

# Determine the script path
TARGET_FILE=$0
cd "$(dirname "$TARGET_FILE")"
TARGET_FILE=$(basename "$TARGET_FILE")
# Iterate down a (possible) chain of symlinks
while [ -L "$TARGET_FILE" ]; do
  TARGET_FILE=$(readlink "$TARGET_FILE")
  cd "$(dirname "$TARGET_FILE")"
  TARGET_FILE=$(basename "$TARGET_FILE")
done
# Put it all together
SCRIPT_PATH=$(pwd -P)/$TARGET_FILE
ROOT=$(dirname $SCRIPT_PATH)

RUBY_VERSION="2.0.0-p195"

###
# installer
###

# Homebrew
if ! installed brew; then
  ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
fi
# install everything from Brewfile
brew bundle $ROOT/Brewfile
# link apps
brew linkapps
# install Casks
$ROOT/home/.cask

# ruby
# temporary env variables to get rbenv to work immediately
export PATH="$HOME/.rbenv/bin:$PATH"
eval "$(rbenv init -)"
# install
if ! rbenv versions --bare | grep $RUBY_VERSION; then
  rbenv install $RUBY_VERSION
fi
rbenv global $RUBY_VERSION
rbenv rehash

# gems
gem install bundler
bundle install --gemfile=$ROOT/Gemfile
rbenv rehash

# oh-my-zsh
if ! [[ -d $HOME/.oh-my-zsh ]]; then
  curl -L https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh | sh
fi

# homesick
homesick clone cknadler/dotfiles
homesick symlink dotfiles

# fonts
mkdir -p $HOME/Library/Fonts
cp $ROOT/fonts/* $HOME/Library/Fonts

# vim-anywhere
if ! [[ -d $HOME/.vim-anywhere ]]; then
  curl -fsSL https://raw.github.com/cknadler/vim-anywhere/master/install | bash
fi

# OSX defaults
# should always be run last as it will shut down Terminal
$ROOT/home/.osx
